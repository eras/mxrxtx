on:
  push:
    tags:
      - 'v*'

name: tag
jobs:
  start:
    name: Create release
    permissions:
      issues: write
      pull-requests: write
      contents: write
    runs-on: ubuntu-latest
    outputs:
      git_describe: ${{ steps.git_describe.outputs.git_describe }}
    steps:
      # https://github.com/actions/create-release
      - uses: actions/checkout@v2
        with:
          submodules: true
      # https://stackoverflow.com/a/58178121
      - name: Set release information
        id: git_describe
        run: echo ::set-output name=git_describe::"$(git describe --tags)"
      # https://stackoverflow.com/a/58178121
      - name: Build started notification
        uses: s3krit/matrix-message-action@v0.0.3
        with:
          room_id: ${{ secrets.MATRIX_ROOM_ID }}
          access_token: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          message: "mxrxtx release ${{ steps.git_describe.outputs.git_describe }} build started. [Progress.](https://github.com/eras/mxrxtx/actions/runs/${{github.run_id}})"
          server: ${{ secrets.MATRIX_SERVER }}
      - name: Cancel if no tag
        if: ${{ steps.git_describe.outputs.git_describe == '' }}
        run: false
  unix:
    name: mxrxtx
    needs: start
    permissions:
      issues: write
      pull-requests: write
      contents: write
    strategy:
      matrix:
        os: [ubuntu-latest]
        # macos-latest crashes
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      - name: Install build deps
        if: ${{ matrix.os == 'ubuntu-latest' }}
        run: sudo apt-get install git
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: build
        env:
          GIT_DESCRIBE: ${{ needs.start.outputs.git_describe }}
        run: 'cargo build --release --locked'
      - run: strip target/release/mxrxtx
        if: ${{ matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest' }}
      - uses: actions/upload-artifact@v2
        with:
          name: mxrxtx
          path: |
            target/release/mxrxtx
            Cargo.lock
        if: ${{ matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest' }}
      # https://github.com/actions/upload-release-asset
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          upload_url: ${{ needs.start.outputs.upload_url }}
          asset_path: ./target/release/mxrxtx
          asset_name: mxrxtx-${{ needs.start.outputs.git_describe }}-${{ runner.os }}.bin
          asset_content_type: application/octet-stream
        if: ${{ matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest' }}
  windows:
    name: mxrxtx
    needs: start
    permissions:
      issues: write
      pull-requests: write
      contents: write
    strategy:
      matrix:
        os: [windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v2
        with:
          submodules: true
      # https://stackoverflow.com/a/58178121
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
      - uses: actions/cache@v2
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: build
        env:
          GIT_DESCRIBE: ${{ needs.start.outputs.git_describe }}
        run: 'cargo build --release'
      - uses: actions/upload-artifact@v2
        with:
          name: mxrxtx
          path: |
            target/release/mxrxtx.exe
            Cargo.lock
      # https://github.com/actions/upload-release-asset
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          # https://jasonet.co/posts/new-features-of-github-actions/#passing-data-to-future-steps
          upload_url: ${{ needs.start.outputs.upload_url }}
          asset_path: ./target/release/mxrxtx.exe
          asset_name: mxrxtx-${{ needs.start.outputs.git_describe }}-${{ runner.os }}.exe
          asset_content_type: application/octet-stream
  notify_end_success:
    runs-on: ubuntu-latest
    needs: [start, unix, windows]
    if: ${{ success() }}
    steps:
      - name: Build succeeded notification
        uses: s3krit/matrix-message-action@v0.0.3
        with:
          room_id: ${{ secrets.MATRIX_ROOM_ID }}
          access_token: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          message: "mxrxtx release ${{ needs.start.outputs.git_describe }} build complete. [Logs.](https://github.com/eras/mxrxtx/actions/runs/${{github.run_id}})"
          server: ${{ secrets.MATRIX_SERVER }}
      - name: Publish release
        uses: eloquent/github-release-action@v3
        with:
          assets: |
            - "mxrxtx-${{ needs.start.outputs.git_describe }}-Windows.exe": "mxrxtx-Windows.exe"
            - "mxrxtx-${{ needs.start.outputs.git_describe }}-Linux.bin": "mxrxtx-Linux.bin"
  notify_end_failed:
    runs-on: ubuntu-latest
    needs: [start, unix, windows]
    if: ${{ failure() }}
    steps:
      - name: Build failed notification
        uses: s3krit/matrix-message-action@v0.0.3
        with:
          room_id: ${{ secrets.MATRIX_ROOM_ID }}
          access_token: ${{ secrets.MATRIX_ACCESS_TOKEN }}
          message: "mxrxtx release ${{ needs.start.outputs.git_describe }} build failed. [Logs.](https://github.com/eras/mxrxtx/actions/runs/${{github.run_id}})"
          server: ${{ secrets.MATRIX_SERVER }}
